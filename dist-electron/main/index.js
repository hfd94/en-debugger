"use strict";var P=Object.defineProperty;var L=(o,e,n)=>e in o?P(o,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[e]=n;var I=(o,e,n)=>L(o,typeof e!="symbol"?e+"":e,n);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const i=require("electron"),M=require("node:module"),U=require("node:url"),c=require("node:path"),k=require("node:os"),A=require("path"),j=require("sqlite3"),D=require("node:crypto");var w=typeof document<"u"?document.currentScript:null;function y(o){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(o){for(const n in o)if(n!=="default"){const t=Object.getOwnPropertyDescriptor(o,n);Object.defineProperty(e,n,t.get?t:{enumerable:!0,get:()=>o[n]})}}return e.default=o,Object.freeze(e)}const $=y(A),C=y(j),S=i.app.getPath("userData");console.log(S);const O=$.join(S,"Storage.bin");console.log("Database path:",O);class v{constructor(){I(this,"db");this.db=new C.Database(O)}open(){return new Promise((e,n)=>{this.db.serialize(()=>{this.db.run("PRAGMA foreign_keys = ON"),console.log("Connected to the database."),e()})})}close(){return new Promise((e,n)=>{this.db.close(t=>{t?n(t):(console.log("Database closed."),e())})})}query(e){return new Promise((n,t)=>{this.db.all(e.sql,e.params,(r,l)=>{r?t(r):n(l)})})}insert(e){return new Promise((n,t)=>{const r=Object.keys(e.data),l=Object.values(e.data),b=r.map(()=>"?").join(","),u=`INSERT INTO ${e.table} (${r.join(",")}) VALUES (${b})`;this.db.run(u,l,function(f){f?t(f):n(this.lastID)})})}update(e){return new Promise((n,t)=>{const r=Object.entries(e.data).map(([u,f])=>`${u} = ?`).join(","),l=Object.values(e.data),b=`UPDATE ${e.table} SET ${r} WHERE ${e.condition}`;this.db.run(b,l,function(u){u?t(u):n(this.changes)})})}delete(e){return new Promise((n,t)=>{const r=`DELETE FROM ${e.table} WHERE ${e.condition}`;console.log(r),this.db.run(r,l=>{l?t(l):n()})})}}const a=new v,x=async()=>{try{await a.open(),await a.query({sql:`
            CREATE TABLE IF NOT EXISTS work_menus ( id TEXT PRIMARY KEY, name TEXT NOT NULL, parentId TEXT, type TEXT );
            `}),await a.query({sql:"CREATE TABLE IF NOT EXISTS work_panel ( id TEXT PRIMARY KEY, url TEXT NOT NULL, type TEXT,  script TEXT );"}),await a.query({sql:"CREATE TABLE IF NOT EXISTS work_quick (id INTEGER PRIMARY KEY AUTOINCREMENT,parentId INTEGER,name TEXT,command TEXT)"}),await a.query({sql:"INSERT INTO work_menus (id, name) VALUES ('1b85da56-5fb6-4d6f-b9b5-295db5530882','测试存放');"}),await a.query({sql:"INSERT INTO work_menus (id, name) VALUES ('1b85da56-5fb6-4d6f-b9b5-295db5530881','演示二级目录');"}),await a.query({sql:"INSERT INTO work_menus (id, name,parentId) VALUES ('1b85da56-5fb6-4d6f-b9b5-295db5530880','二级目录','1b85da56-5fb6-4d6f-b9b5-295db5530881');"}),await a.query({sql:"INSERT INTO work_menus (id, name,parentId,type) VALUES ('1b85da56','WebSocket','1b85da56-5fb6-4d6f-b9b5-295db5530882','websocket');"}),await a.query({sql:"INSERT INTO work_menus (id, name,parentId,type) VALUES ('1b85da51','Http-Get','1b85da56-5fb6-4d6f-b9b5-295db5530882','get');"}),await a.query({sql:"INSERT INTO work_panel (id, url,type) VALUES ('1b85da56','ws://127.0.0.1:3000','websocket');"}),await a.query({sql:"INSERT INTO work_panel (id, url,type) VALUES ('1b85da51','http://www.baidu.com','get');"}),console.log("Database initialized.")}catch(o){console.error("Error opening database:",o)}},E=a.query.bind(a),R=a.insert.bind(a);a.update.bind(a);const _=a.delete.bind(a);M.createRequire(typeof document>"u"?require("url").pathToFileURL(__filename).href:w&&w.tagName.toUpperCase()==="SCRIPT"&&w.src||new URL("index.js",document.baseURI).href);const g=c.dirname(U.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:w&&w.tagName.toUpperCase()==="SCRIPT"&&w.src||new URL("index.js",document.baseURI).href)),q="hex-editor";process.env.APP_ROOT=c.join(g,"../..");const V=c.join(process.env.APP_ROOT,"dist-electron"),T=c.join(process.env.APP_ROOT,"dist"),d=process.env.VITE_DEV_SERVER_URL;process.env.VITE_PUBLIC=d?c.join(process.env.APP_ROOT,"public"):T;k.release().startsWith("6.1")&&i.app.disableHardwareAcceleration();process.platform==="win32"&&i.app.setAppUserModelId(i.app.getName());i.app.requestSingleInstanceLock()||(i.app.quit(),process.exit(0));let s=null;const h=c.join(g,"../preload/index.js"),m=c.join(T,"index.html");async function N(){s=new i.BrowserWindow({title:"Main window",autoHideMenuBar:!0,icon:c.join(process.env.VITE_PUBLIC,"favicon.ico"),width:1120,height:720,minWidth:1120,minHeight:720,frame:!1,webPreferences:{webSecurity:!1,devTools:!0,preload:h}}),d?(s.loadURL(d),s.webContents.openDevTools()):s.loadFile(m),s.webContents.on("did-finish-load",()=>{s==null||s.webContents.send("main-process-message",new Date().toLocaleString())}),s.webContents.setWindowOpenHandler(({url:o})=>(o.startsWith("https:")&&i.shell.openExternal(o),{action:"deny"}))}i.app.whenReady().then(async()=>{await x(),N()});i.app.on("window-all-closed",()=>{s=null,process.platform!=="darwin"&&i.app.quit()});i.app.on("second-instance",()=>{s&&(s.isMinimized()&&s.restore(),s.focus())});i.app.on("activate",()=>{const o=i.BrowserWindow.getAllWindows();o.length?o[0].focus():N()});const p={};i.ipcMain.handle("dialog:openFile",async o=>(await i.dialog.showOpenDialog({title:"选择Proto文件",filters:[{name:"proto文件",extensions:["proto"]},{name:"所有文件",extensions:["*"]}],properties:["openFile","multiSelections"]})).filePaths);i.ipcMain.handle("open-win",(o,e)=>{if(!Object.hasOwn(p,e)){const n=new i.BrowserWindow({autoHideMenuBar:!0,frame:!1,parent:s,webPreferences:{preload:h,nodeIntegration:!0}});d?(console.log(`${d}#${e}`),n.loadURL(`${d}#${e}`)):n.loadFile(m,{hash:e}),p[e]=n}});i.ipcMain.handle("open-hex-editor",(o,e)=>{let n=p[q];if(n)n.webContents.send("data-from-main",{key:e});else{const t=new i.BrowserWindow({autoHideMenuBar:!0,frame:!1,parent:s,webPreferences:{preload:h,nodeIntegration:!0}});d?(console.log(`${d}#hex-editor`),t.loadURL(`${d}#hex-editor`)):t.loadFile(m,{hash:"hex-editor"}),p[q]=t,n=t,n.webContents.on("did-finish-load",()=>{n.webContents.send("data-from-main",{key:e})})}});i.ipcMain.on("window-min",function(){s&&s.minimize()});i.ipcMain.on("window-max",function(){s&&(s.isMaximized()?s.restore():s.maximize())});i.ipcMain.on("window-close",(o,...e)=>{if(console.log(e),e[0])Object.hasOwn(p,e[0])&&(p[e[0]].close(),delete p[e[0]]);else{if(!s)return;process.platform!=="darwin"&&i.app.quit()}});i.ipcMain.handle("insert-menu-folder",async(o,e)=>{e.id=D.randomUUID();let n="";e.type&&(n=e.url,delete e.url),await R({table:"work_menus",data:e}),e.type&&await R({table:"work_panel",data:{id:e.id,url:n,type:e.type}})});const W=o=>{const e=new Map,n=[];return o.forEach(t=>{e.set(t.id,{id:t.id,title:t.name,type:t.type,children:t.type===null?[]:null})}),o.forEach(t=>{const r=e.get(t.id);if(t.parentId){const l=e.get(t.parentId);l.children!==null&&l.children.push(r)}else n.push(r)}),n};i.ipcMain.handle("get-work-menus",async(o,e)=>{const n=await E({sql:"SELECT * FROM work_menus;"});return W(n)});i.ipcMain.handle("delete-menu",async(o,e)=>{const n=[];e.tab.forEach(t=>{n.push(`'${t}'`)}),await _({table:"work_menus",condition:`id in (${n.join(",")})`}),e.page.length>0&&(n.length=0,e.page.forEach(t=>{n.push(`'${t}'`)}),await _({table:"work_panel",condition:`id in (${n.join(",")})`}))});i.ipcMain.handle("get-panel-info",async(o,e)=>{const n=`SELECT * FROM work_panel where id = '${e.id}';`;return await E({sql:n})});i.ipcMain.handle("get-quick-info",async(o,e)=>{const n=`SELECT * FROM work_quick where parentId = '${e.id}';`;return await E({sql:n})});exports.MAIN_DIST=V;exports.RENDERER_DIST=T;exports.VITE_DEV_SERVER_URL=d;
